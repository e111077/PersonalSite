<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="./elliott-post-page.html">

<dom-module id="elliott-main-page">
  <template>
    <style>
       :host {
        --main-font: ElliScript, "Comic Sans MS", cursive, sans-serif;
      }

      #headerBar {
        background-color: black;
        font-size: 3em;
        padding-top: .3em;
        padding-bottom: .3em;
        text-align: center;
      }

      .postListing {
        font-size: 2em;
      }

      .date {
        color: #AAAAAA;
        float: right;
      }

      a {
        color: black;
        text-decoration: none;
      }

      #headerBar * {
        color: white;
      }

      a:hover {
        text-decoration: underline;
      }

      ul {
        list-style: none;
        padding: 0;
        width: 60%;
        margin: 0 auto;
        margin-top: 1em;
      }

      #back-icon {
        position: absolute;
        margin-left: .5em;
        left: 0;
      }

      #back-icon:hover {
        text-decoration: none;
      }

      .elliscript {
        font-family: var(--main-font);
      }
    </style>

    <iron-location
        path="{{path}}">
    </iron-location>

    <div id="headerBar" class="elliscript">
      <a href="/main" id="back-icon" hidden$="[[!_isBackVisible(page)]]">&lt;</a>
      <a href="/">Elliott Marquez</a>
    </div>

    <iron-pages attr-for-selected="page" selected="[[page]]" fallback-selection="main">
      <div page="main">
        <ul>
          <dom-repeat items="[[posts]]" as="post">
            <template>
              <li class="postListing elliscript">
                <span><a href$="/post/[[post.filename]]">[[post.title]]</a></span>
                <span class="date">-[[post.date]]</span>
              </li>
            </template>
          </dom-repeat>
        </ul>
      </div>

      <elliott-post-page
          page="post"
          loading="[[loadingPost]]"
          markdown="[[postMarkdown]]">
      </elliott-post-page>
    </iron-pages>
  </template>

  <script>
    class ElliottMainPage extends Polymer.Element {
      static get is() { return 'elliott-main-page' }

      static get properties() {
        const props = {
          posts: {
            type: Array,
            value: [
              {
                title: 'Hello World',
                filename: 'hello-world',
                date: 'March 26, 2017'
              }
            ]
          },
          path: {
            type: String,
            observer: '_pathChanged'
          },
          hash: String,
          loadingPost: Boolean,
          postMarkdown: String,
          page: String
        }

        return props;
      }

      _pathChanged() {
        if (!this.path) { return }

        let pathParts = this.path.split('/');

        if (pathParts.length > 2 && pathParts[1] == 'post') {
          this.loadingPost = true;

          if (!window.fetch) {
            this.postMarkdown = 'Your browser does not support [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API). Please use a better browser listed in [this table](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API#Browser_compatibility).'
            this.loadingPost = false;

          } else {
            fetch(`/posts/${pathParts[2]}.md`).then(res => {
              this.postMarkdown = res.text().then(markdown => {
                this.postMarkdown = markdown;
                this.loadingPost = false;
              });

            }).catch(_ => {
              this.loadingPost = false;
            });
          }
        }

        if (pathParts.length > 1) {
          this.page = pathParts[1];
        }
      }

      _isBackVisible() {
        return this.page !== '' && this.page !== 'main';
      }
    }

    customElements.define(ElliottMainPage.is, ElliottMainPage);
  </script>
</dom-module>