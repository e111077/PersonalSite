<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="./elliott-post-page.html">
<link rel="import" href="./elliott-nav-section.html">

<dom-module id="elliott-main-page">
  <template>
    <style>
       :host {
        --main-font: ElliScript, Apple Symbols, BlinkMacSystemFont,
            "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      #header-bar {
        background-color: black;
        font-size: 3em;
        padding-top: .3em;
        padding-bottom: .3em;
        text-align: center;
        margin-bottom: .3em;
        height: 44.78px;
      }

      iron-pages {
        flex-grow: 1;
      }

      .postListing {
        font-size: 2em;
      }

      .date {
        color: #AAAAAA;
        float: right;
      }

      a {
        color: black;
        text-decoration: none;
      }

      #header-bar * {
        color: white;
      }

      a:hover {
        text-decoration: underline;
      }

      #body-wrapper {
        width: 80%;
        margin: 0 auto;
        display: flex;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0 auto;
        margin-top: 1em;
      }

      #back-icon {
        margin-left: .5em;
        position: absolute;
        left: 0;
      }

      #back-icon:hover {
        text-decoration: none;
      }

      .elliscript {
        font-family: var(--main-font);
      }

      @media (max-width: 600px) {
        #body-wrapper {
          display: flex;
          flex-direction: column;
          width: 95%;
        }
      }
    </style>

    <iron-location
        path="{{path}}">
    </iron-location>

    <div id="header-bar" class="elliscript">
      <a href="/blog" id="back-icon" hidden$="[[!_isBackVisible(page)]]">&lt;</a>
      <a href="/" id="header-title">Elliott Marquez</a>
    </div>

    <div id="body-wrapper">
      <elliott-nav-section page="[[page]]"></elliott-nav-section>

      <iron-pages attr-for-selected="page" selected="[[page]]" fallback-selection="blog">
        <div page="blog">
          <ul>
            <dom-repeat items="[[posts]]" as="post">
              <template>
                <li class="postListing elliscript">
                  <span><a href$="/post/[[post.filename]]">[[post.title]]</a></span>
                  <span class="date">-[[post.date]]</span>
                </li>
              </template>
            </dom-repeat>
          </ul>
        </div>

        <elliott-post-page
            page="post"
            loading="[[loadingPost]]"
            markdown="[[postMarkdown]]">
        </elliott-post-page>

        <elliott-post-page
            page="about"
            loading="[[loadingPost]]"
            markdown="[[postMarkdown]]">
        </elliott-post-page>
      </iron-pages>
    </div>
  </template>

  <script>
    class ElliottMainPage extends Polymer.Element {
      static get is() { return 'elliott-main-page' }

      static get properties() {
        const props = {
          posts: {
            type: Array,
            value: [
              {
                title: 'Hello World',
                filename: 'hello-world',
                date: 'April 7, 2017'
              }
            ]
          },
          path: {
            type: String,
            observer: '_pathChanged'
          },
          hash: String,
          loadingPost: Boolean,
          postMarkdown: String,
          page: String
        }

        return props;
      }

      _pathChanged() {
        if (!this.path) { return }

        let pathParts = this.path.split('/');
        let page;

        if (pathParts.length > 1) {
          page = pathParts[1];
        }

        if (pathParts.length > 2 && page == 'post' || page == 'about') {
          this.loadingPost = true;

          if (!window.fetch) {
            this.postMarkdown = `Your browser does not support
            [fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API).
            Please use a better browser listed in
            [this table](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API#Browser_compatibility).`
            this.loadingPost = false;

          } else {
            let postName = '';

            if (page === 'post') {
              postName = pathParts[2];

            } else if (page === 'about') {
              postName = `about-me`
            }
            fetch(`/posts/${postName}.md`).then(res => {
              return res.text();
            }).then(markdown => {
              this.postMarkdown = markdown;
              this.loadingPost = false;
            }).catch(_ => {
              this.loadingPost = false;
            });
          }
        }

        if (pathParts.length > 1) {
          this.page = page;
        }
      }

      _isBackVisible() {
        return this.page !== '' && this.page !== 'blog';
      }
    }

    customElements.define(ElliottMainPage.is, ElliottMainPage);
  </script>
</dom-module>